version: '3.9'

services:
  backend:
    image: python:3.12-slim
    working_dir: /app
    volumes:
      - ./backend:/app
    command: ['/bin/sh', '-c', 'pip install poetry && poetry install && poetry run uvicorn main:app --host 0.0.0.0 --port 8000']
    ports:
      - '8000'
    networks:
      - dokploy-network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.backend.rule=Host(`your-domain.com`)' # Change your-domain.com to actual domain
      - 'traefik.http.routers.backend.entrypoints=websecure'
      - 'traefik.http.routers.backend.tls.certResolver=letsencrypt'
      - 'traefik.http.services.backend.loadbalancer.server.port=8000'

  frontend:
    image: node:latest
    working_dir: /app
    volumes:
      - ./mini-app:/app
    command: ['/bin/sh', '-c', 'npm install && npm run build && npm start']
    ports:
      - '6969'
    networks:
      - dokploy-network
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.frontend.rule=Host(`your-domain.com`)' # Change your-domain.com to actual domain
      - 'traefik.http.routers.frontend.entrypoints=websecure'
      - 'traefik.http.routers.frontend.tls.certResolver=letsencrypt'
      - 'traefik.http.services.frontend.loadbalancer.server.port=6969'

networks:
  dokploy-network:
    external: true
